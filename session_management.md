# Session Management System

## Overview
Technical foundation for managing chat sessions with backend integration. Each session has a unique ID, title, description, and optional thumbnail generated by the backend.

## Backend Integration

### Webhook Endpoint
- **URL**: `POST https://automation.kwaaijongens.nl/webhook/sessions`
- **Authentication**: Basic Auth
  - Username: `kj-app`
  - Password: `ar6e!GyXu`

### Request Format
All requests include a `method` field to specify the action:

```json
{
  "method": "create|list|update|delete|get",
  "sessionId": "session_1724567890123",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name",
  // Additional fields based on method
}
```

## API Methods

### 1. Create Session
**Request:**
```json
{
  "method": "create",
  "sessionId": "session_1724567890123",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Session created successfully",
  "data": {
    "sessionId": "session_1724567890123",
    "title": "Auto-generated title",
    "description": "Auto-generated description",
    "thumbnail": "optional_thumbnail_url"
  }
}
```

### 2. List Sessions
**Request:**
```json
{
  "method": "list",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name"
}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "sessionId": "session_1724567890123",
      "title": "Project Discussion",
      "description": "Mobile app features",
      "thumbnail": null,
      "lastActivity": "2024-01-01T11:30:00Z",
      "messageCount": 15
    }
  ]
}
```

### 3. Update Session
**Request:**
```json
{
  "method": "update",
  "sessionId": "session_1724567890123",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name",
  "title": "Updated Title",
  "description": "Updated Description"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Session updated successfully",
  "data": {
    "title": "New auto-generated title",
    "description": "New auto-generated description",
    "thumbnail": "optional_thumbnail_url"
  }
}
```

### 4. Delete Session
**Request:**
```json
{
  "method": "delete",
  "sessionId": "session_1724567890123",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Session deleted successfully"
}
```

### 5. Get Session Details
**Request:**
```json
{
  "method": "get",
  "sessionId": "session_1724567890123",
  "phoneNumber": "+31612345678",
  "name": "User Name",
  "companyName": "Company Name"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessionId": "session_1724567890123",
    "title": "Project Discussion",
    "description": "Mobile app features",
    "thumbnail": null,
    "createdAt": "2024-01-01T10:00:00Z",
    "lastActivity": "2024-01-01T11:30:00Z",
    "messageCount": 15
  }
}
```

## Implementation Decisions

### Session Creation
- **When**: Immediately when `SessionService.startNewSession()` is called
- **How**: Synchronous call to backend, continue if fails
- **Fallback**: Local-only session if backend unavailable

### Error Handling
- **Backend Failure**: Continue with local-only session
- **Retry Strategy**: No automatic retry
- **User Notification**: Show error message to user

### Sync Strategy
- **Startup**: Sync session list on app startup
- **Manual**: User can explicitly refresh session list
- **Background**: No periodic background sync

### Data Priority
- **Source of Truth**: Backend always takes precedence
- **Local Cache**: Used for offline functionality only
- **Conflicts**: Backend data overwrites local data

### Session ID Format
- **Format**: `session_${timestamp}` (e.g., `session_1724567890123`)
- **Generation**: Client-side using current timestamp
- **Uniqueness**: Timestamp ensures uniqueness per user

### User Identification
- **Phone Number**: Primary identifier
- **Name**: User's display name
- **Company**: User's company name
- **All Required**: All three fields sent in every request

## Technical Implementation

### API Service Changes
- Add Basic Auth support for session webhook
- Implement 5 session management methods
- Handle immediate response with title/description
- Include user identification in all requests

### Session Service Changes
- Modify `startNewSession()` to call backend immediately
- Add session metadata caching
- Add sync methods for startup and manual refresh
- Maintain backward compatibility

### Storage Service Changes
- Add session metadata storage
- Cache session list locally
- Handle backend as source of truth

### Integration Points
- Chat screen syncs sessions on startup
- Update session after sending messages
- Show backend errors to user
- Maintain existing sessionId functionality

## Future Enhancements
- Session switching UI components
- Session editing interface
- Thumbnail management
- Session search and filtering
- Bulk session operations